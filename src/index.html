<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
  <title>Social Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-deep: #08080c;
      --bg-primary: #0c0c12;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a24;
      --bg-hover: #22222e;
      --border: #2a2a3a;
      --border-subtle: #1e1e2a;
      --text-primary: #e8e8f0;
      --text-secondary: #8888a0;
      --text-muted: #5a5a70;
      --accent-messenger: #0084ff;
      --accent-instagram: #e1306c;
      --accent-instagram-stats: #833ab4;
      --accent-tiktok: #00f2ea;
      --accent-gmail: #ea4335;
      --accent-outlook: #0078d4;
      --accent-custom: #10b981;
      --accent-glow: rgba(0, 132, 255, 0.15);
      --badge-bg: #ef4444;
    }

    body {
      font-family: 'Space Grotesk', -apple-system, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Title Bar */
    .titlebar {
      height: 38px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      -webkit-app-region: drag;
      user-select: none;
    }

    .titlebar-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .titlebar-title svg {
      width: 16px;
      height: 16px;
      opacity: 0.7;
    }

    .titlebar-shortcuts {
      font-size: 10px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .window-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .window-btn {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .window-btn:hover { opacity: 0.8; }
    .btn-close { background: #ff5f57; }
    .btn-minimize { background: #febc2e; }
    .btn-maximize { background: #28c840; }

    /* Main Layout */
    .app-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 64px;
      background: var(--bg-primary);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      gap: 4px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sidebar::-webkit-scrollbar {
      width: 0;
    }

    /* Tab Groups */
    .tab-group {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .tab-group-header {
      width: 48px;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 0 4px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    .tab-group-header:hover {
      color: var(--text-secondary);
    }

    .tab-group-tabs {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .tab-button {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      position: relative;
    }

    .tab-button::before {
      content: '';
      position: absolute;
      left: -8px;
      width: 3px;
      height: 0;
      background: var(--text-primary);
      border-radius: 0 2px 2px 0;
      transition: height 0.2s ease;
    }

    .tab-button:hover { background: var(--bg-hover); }
    .tab-button.active { background: var(--bg-tertiary); }
    .tab-button.active::before { height: 20px; }

    .tab-button svg {
      width: 22px;
      height: 22px;
      color: var(--text-secondary);
      transition: color 0.2s;
    }

    .tab-button:hover svg,
    .tab-button.active svg { color: var(--text-primary); }

    .tab-button.messenger svg { color: var(--accent-messenger); }
    .tab-button.instagram-chat svg { color: var(--accent-instagram); }
    .tab-button.instagram-stats svg { color: var(--accent-instagram-stats); }
    .tab-button.tiktok svg { color: var(--accent-tiktok); }
    .tab-button.gmail svg { color: var(--accent-gmail); }
    .tab-button.outlook svg { color: var(--accent-outlook); }
    .tab-button.custom svg { color: var(--accent-custom); }

    /* Notification Badge */
    .tab-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: var(--badge-bg);
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 9px;
      display: none;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--bg-primary);
    }

    .tab-badge.visible { display: flex; }

    /* Tab number indicator */
    .tab-number {
      position: absolute;
      bottom: 2px;
      right: 4px;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .tab-button .close-tab {
      position: absolute;
      top: -4px;
      left: -4px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 10px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .tab-button:hover .close-tab { display: flex; }
    .close-tab:hover {
      background: #ff5f57;
      color: white;
      border-color: #ff5f57;
    }

    .sidebar-divider {
      width: 32px;
      height: 1px;
      background: var(--border);
      margin: 8px 0;
    }

    .add-tab-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 2px dashed var(--border);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      margin-top: auto;
      flex-shrink: 0;
    }

    .add-tab-btn:hover {
      border-color: var(--text-secondary);
      background: var(--bg-secondary);
    }

    .add-tab-btn svg {
      width: 20px;
      height: 20px;
      color: var(--text-muted);
      transition: color 0.2s;
    }

    .add-tab-btn:hover svg { color: var(--text-secondary); }

    /* Content Area */
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-deep);
      position: relative;
      overflow: hidden;
      height: 100%;
    }

    #tab-contents {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .tab-content {
      flex: 1;
      display: none;
      position: relative;
      height: 100%;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .tab-content webview {
      width: 100%;
      height: 100%;
      flex: 1;
      border: none;
      display: flex;
    }

    .webview-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      flex: 1;
    }

    .webview-wrapper webview {
      flex: 1;
      width: 100%;
      min-height: 0;
    }

    /* Welcome Screen */
    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      padding: 40px;
    }

    .welcome-icon {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
    }

    .welcome-icon svg {
      width: 40px;
      height: 40px;
      color: var(--text-secondary);
    }

    .welcome-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .welcome-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      max-width: 400px;
      line-height: 1.6;
    }

    .shortcuts-hint {
      display: flex;
      gap: 16px;
      margin-top: 16px;
    }

    .shortcut {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .shortcut kbd {
      background: var(--bg-tertiary);
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      border: 1px solid var(--border);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--bg-secondary);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: none;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .modal-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    /* Service Categories */
    .service-category {
      margin-bottom: 16px;
    }

    .service-category:last-child {
      margin-bottom: 0;
    }

    .category-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding-left: 4px;
    }

    .service-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .service-option {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .service-option:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
      transform: translateX(4px);
    }

    .service-option svg {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
    }

    .service-option.messenger svg { color: var(--accent-messenger); }
    .service-option.instagram-chat svg { color: var(--accent-instagram); }
    .service-option.instagram-stats svg { color: var(--accent-instagram-stats); }
    .service-option.tiktok svg { color: var(--accent-tiktok); }
    .service-option.gmail svg { color: var(--accent-gmail); }
    .service-option.outlook svg { color: var(--accent-outlook); }
    .service-option.custom svg { color: var(--accent-custom); }

    .service-info { flex: 1; }

    .service-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 1px;
    }

    .service-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Custom Service Form */
    .custom-form {
      display: none;
      flex-direction: column;
      gap: 16px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .custom-form.active { display: flex; }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .form-input {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.15s;
    }

    .form-input:focus {
      border-color: var(--accent-custom);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .form-select {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      cursor: pointer;
    }

    .btn-primary {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      background: var(--accent-custom);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .btn-primary:hover { opacity: 0.9; }

    .btn-secondary {
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }

    /* Rename Modal */
    .rename-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Webview toolbar */
    .webview-toolbar {
      height: 40px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      padding: 0 12px;
      gap: 8px;
    }

    .nav-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .nav-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .nav-btn svg {
      width: 16px;
      height: 16px;
    }

    .url-display {
      flex: 1;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-secondary);
      padding: 6px 12px;
      border-radius: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tab-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 6px;
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .tab-label:hover {
      background: var(--bg-hover);
    }

    .tab-label.messenger { color: var(--accent-messenger); }
    .tab-label.instagram-chat { color: var(--accent-instagram); }
    .tab-label.instagram-stats { color: var(--accent-instagram-stats); }
    .tab-label.tiktok { color: var(--accent-tiktok); }
    .tab-label.gmail { color: var(--accent-gmail); }
    .tab-label.outlook { color: var(--accent-outlook); }
    .tab-label.custom { color: var(--accent-custom); }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px;
      min-width: 160px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: none;
    }

    .context-menu.active { display: block; }

    .context-item {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s;
    }

    .context-item:hover {
      background: var(--bg-hover);
    }

    .context-item svg {
      width: 14px;
      height: 14px;
      color: var(--text-secondary);
    }

    .context-divider {
      height: 1px;
      background: var(--border);
      margin: 6px 0;
    }

    .context-item.danger { color: #ef4444; }
    .context-item.danger svg { color: #ef4444; }

    /* Email UI Styles */
    .email-container {
      display: flex;
      height: 100%;
      background: var(--bg-deep);
    }

    .email-sidebar {
      width: 200px;
      background: var(--bg-primary);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      padding: 12px;
    }

    .email-account-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      margin-bottom: 12px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .email-folders {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .email-folder {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .email-folder:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .email-folder.active {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .email-folder svg {
      width: 16px;
      height: 16px;
    }

    .compose-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      margin-top: 12px;
      border: none;
      border-radius: 8px;
      background: var(--accent-custom);
      color: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .compose-btn:hover {
      opacity: 0.9;
    }

    .compose-btn svg {
      width: 16px;
      height: 16px;
    }

    .email-list {
      width: 350px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-subtle);
      overflow-y: auto;
    }

    .email-loading {
      padding: 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    .email-item {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: background 0.15s;
    }

    .email-item:hover {
      background: var(--bg-tertiary);
    }

    .email-item.active {
      background: var(--bg-tertiary);
      border-left: 3px solid var(--accent-custom);
    }

    .email-item.unread {
      background: var(--bg-tertiary);
    }

    .email-item.unread .email-item-from {
      font-weight: 600;
      color: var(--text-primary);
    }

    .email-item-from {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .email-item-subject {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .email-item-preview {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .email-item-date {
      font-size: 11px;
      color: var(--text-muted);
      float: right;
    }

    .email-viewer {
      flex: 1;
      background: var(--bg-deep);
      overflow-y: auto;
      padding: 24px;
    }

    .email-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      font-size: 14px;
    }

    .email-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .email-toolbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .email-toolbar-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .email-toolbar-btn.danger:hover {
      background: #dc262622;
      color: #ef4444;
      border-color: #ef4444;
    }

    .email-toolbar-btn.primary {
      background: var(--accent-custom);
      border-color: var(--accent-custom);
      color: white;
    }

    .email-toolbar-btn.primary:hover {
      filter: brightness(1.1);
    }

    .email-toolbar-btn svg {
      width: 14px;
      height: 14px;
    }

    .email-toolbar-divider {
      width: 1px;
      background: var(--border);
      margin: 0 4px;
    }

    .email-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .email-subject {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .email-meta {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-secondary);
      flex-wrap: wrap;
    }

    .email-body {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-primary);
    }

    .email-body a {
      color: var(--accent-custom);
    }

    /* Compose Modal */
    .compose-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .compose-modal.active {
      display: flex;
    }

    .compose-content {
      background: var(--bg-primary);
      border-radius: 12px;
      width: 600px;
      max-width: 90vw;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
    }

    .compose-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .compose-header h3 {
      margin: 0;
      font-size: 16px;
      color: var(--text-primary);
    }

    .compose-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    .compose-close:hover {
      color: var(--text-primary);
    }

    .compose-body {
      padding: 16px 20px;
      flex: 1;
      overflow-y: auto;
    }

    .compose-field {
      margin-bottom: 12px;
    }

    .compose-field label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .compose-field input,
    .compose-field textarea {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .compose-field textarea {
      min-height: 200px;
      resize: vertical;
      font-family: inherit;
    }

    .compose-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }

    .compose-btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .compose-btn-cancel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .compose-btn-cancel:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .compose-btn-send {
      background: var(--accent-custom);
      border: none;
      color: white;
    }

    .compose-btn-send:hover {
      filter: brightness(1.1);
    }

    .compose-btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Email item actions on hover */
    .email-item-actions {
      display: none;
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      gap: 4px;
    }

    .email-item:hover .email-item-actions {
      display: flex;
    }

    .email-item:hover .email-item-date {
      display: none;
    }

    .email-item {
      position: relative;
    }

    .email-action-btn {
      padding: 6px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
      cursor: pointer;
    }

    .email-action-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .email-action-btn svg {
      width: 14px;
      height: 14px;
      display: block;
    }
  </style>
</head>
<body>
  <!-- Title Bar -->
  <div class="titlebar">
    <div class="titlebar-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
        <path d="M2 17l10 5 10-5"/>
        <path d="M2 12l10 5 10-5"/>
      </svg>
      SOCIAL HUB
    </div>
    <div class="titlebar-shortcuts">Ctrl+1-9 switch tabs â€¢ Ctrl+N new tab</div>
    <div class="window-controls">
      <button class="window-btn btn-minimize" onclick="electronAPI.minimize()"></button>
      <button class="window-btn btn-maximize" onclick="electronAPI.maximize()"></button>
      <button class="window-btn btn-close" onclick="electronAPI.close()"></button>
    </div>
  </div>

  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div id="tab-groups"></div>
      <div class="sidebar-divider"></div>
      <button class="add-tab-btn" onclick="openAddModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </button>
    </div>

    <!-- Content Area -->
    <div class="content-area">
      <div id="tab-contents">
        <div class="welcome-screen" id="welcome-screen">
          <div class="welcome-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
            </svg>
          </div>
          <h1 class="welcome-title">Welcome to Social Hub</h1>
          <p class="welcome-subtitle">
            Add your first service tab to get started. Each tab maintains its own login session, so you can use multiple accounts simultaneously.
          </p>
          <div class="shortcuts-hint">
            <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>N</kbd> New tab</div>
            <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>1-9</kbd> Switch tabs</div>
            <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>W</kbd> Close tab</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Tab Modal -->
  <div class="modal-overlay" id="add-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Add Service</h2>
        <button class="modal-close" onclick="closeAddModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <!-- Social Services -->
      <div class="service-category">
        <div class="category-title">Social</div>
        <div class="service-list">
          <div class="service-option messenger" onclick="addTab('messenger')">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.477 2 2 6.145 2 11.243c0 2.936 1.444 5.544 3.7 7.256v3.501l3.363-1.847c.898.248 1.85.382 2.837.382 5.523 0 10-4.145 10-9.243S17.523 2 12 2zm1.093 12.426l-2.547-2.72-4.97 2.72 5.467-5.803 2.612 2.72 4.905-2.72-5.467 5.803z"/>
            </svg>
            <div class="service-info">
              <div class="service-name">Messenger</div>
              <div class="service-desc">Facebook chat & comments</div>
            </div>
          </div>
          <div class="service-option instagram-chat" onclick="addTab('instagram-chat')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="20" rx="5"/>
              <circle cx="12" cy="12" r="4"/>
              <circle cx="18" cy="6" r="1.5" fill="currentColor"/>
            </svg>
            <div class="service-info">
              <div class="service-name">Instagram Chat</div>
              <div class="service-desc">DMs & comment replies</div>
            </div>
          </div>
          <div class="service-option instagram-stats" onclick="addTab('instagram-stats')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/>
            </svg>
            <div class="service-info">
              <div class="service-name">Instagram Analytics</div>
              <div class="service-desc">Post stats & insights</div>
            </div>
          </div>
          <div class="service-option tiktok" onclick="addTab('tiktok')">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
            </svg>
            <div class="service-info">
              <div class="service-name">TikTok Analytics</div>
              <div class="service-desc">Video stats & performance</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Email Services -->
      <div class="service-category">
        <div class="category-title">Email</div>
        <div class="service-list">
          <div class="service-option" style="cursor: pointer;" onclick="addTab('email-imap')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--accent-custom);">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
            <div class="service-info">
              <div class="service-name">Email (IMAP)</div>
              <div class="service-desc">Gmail, Outlook, Yahoo & more</div>
            </div>
          </div>
          <div class="service-option gmail" style="opacity: 0.5; cursor: not-allowed;" onclick="showComingSoon('Gmail direct login')">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/>
            </svg>
            <div class="service-info">
              <div class="service-name">Gmail <span style="font-size: 10px; background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; margin-left: 6px;">Coming Soon</span></div>
              <div class="service-desc">Direct webview login</div>
            </div>
          </div>
          <div class="service-option outlook" onclick="addTab('outlook')">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M24 7.387v10.478c0 .23-.08.424-.238.576-.158.154-.352.23-.58.23h-8.547v-6.959l1.6 1.18c.106.077.236.116.388.116.152 0 .283-.04.39-.116l6.87-5.1c.095-.063.166-.063.214 0 .047.063.047.148 0 .254l-.097.341zm-.818-1.06c0-.167-.044-.247-.133-.24-.09.006-.2.073-.332.2l-7.127 5.298-1.954-1.442V7.387c0-.23-.08-.424-.238-.576-.158-.153-.352-.23-.58-.23H7.636v14.838h14.546c.228 0 .422-.077.58-.23.158-.152.238-.346.238-.577V6.328zM7.091 3.844c0-.307-.1-.557-.299-.75-.2-.193-.463-.29-.79-.29H.79c-.327 0-.59.097-.79.29-.2.193-.3.443-.3.75v14.52c0 .306.1.556.3.75.2.192.463.289.79.289h5.21V3.844zm.545 8.66c0-1.14-.298-2.06-.894-2.759-.597-.699-1.391-1.049-2.381-1.049-.99 0-1.784.35-2.38 1.049-.598.7-.897 1.62-.897 2.76s.299 2.06.896 2.759c.597.699 1.39 1.048 2.381 1.048s1.784-.35 2.38-1.048c.597-.7.895-1.62.895-2.76zm-2.198 0c0 .615-.105 1.084-.316 1.408-.21.324-.513.486-.907.486-.394 0-.697-.162-.908-.486-.21-.324-.316-.793-.316-1.408s.105-1.085.316-1.408c.21-.324.514-.486.908-.486.394 0 .696.162.907.486.21.323.316.793.316 1.408z"/>
            </svg>
            <div class="service-info">
              <div class="service-name">Outlook Web</div>
              <div class="service-desc">Microsoft webmail</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Custom Service -->
      <div class="service-category">
        <div class="category-title">Other</div>
        <div class="service-list">
          <div class="service-option custom" onclick="showCustomForm()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="16"/>
              <line x1="8" y1="12" x2="16" y2="12"/>
            </svg>
            <div class="service-info">
              <div class="service-name">Custom Service</div>
              <div class="service-desc">Add any website</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Custom Form -->
      <div class="custom-form" id="custom-form">
        <div class="form-group">
          <label class="form-label">Service Name</label>
          <input type="text" class="form-input" id="custom-name" placeholder="e.g., Work Email">
        </div>
        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="url" class="form-input" id="custom-url" placeholder="https://mail.example.com">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Group</label>
            <select class="form-select" id="custom-group">
              <option value="default">Default</option>
              <option value="work">Work</option>
              <option value="personal">Personal</option>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 12px;">
          <button class="btn-secondary" onclick="hideCustomForm()" style="flex: 1;">Cancel</button>
          <button class="btn-primary" onclick="addCustomTab()" style="flex: 1;">Add Service</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div class="modal-overlay" id="rename-modal">
    <div class="modal" style="width: 320px;">
      <div class="modal-header">
        <h2 class="modal-title">Rename Tab</h2>
        <button class="modal-close" onclick="closeRenameModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="rename-form">
        <div class="form-group">
          <label class="form-label">Tab Name</label>
          <input type="text" class="form-input" id="rename-input" placeholder="Enter new name">
        </div>
        <div class="form-group">
          <label class="form-label">Group</label>
          <select class="form-select" id="rename-group">
            <option value="default">Default</option>
            <option value="work">Work</option>
            <option value="personal">Personal</option>
          </select>
        </div>
        <button class="btn-primary" onclick="saveRename()">Save</button>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="context-menu">
    <div class="context-item" onclick="renameCurrentTab()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 20h9"/>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
      </svg>
      Rename
    </div>
    <div class="context-item" onclick="changeGroup()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
      </svg>
      Change Group
    </div>
    <div class="context-item" onclick="reloadCurrentTab()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M23 4v6h-6M1 20v-6h6"/>
        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
      </svg>
      Reload
    </div>
    <div class="context-divider"></div>
    <div class="context-item danger" onclick="closeCurrentTab()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
      Close Tab
    </div>
  </div>

  <!-- Auth Modal for Gmail etc -->
  <div class="modal-overlay" id="auth-modal">
    <div class="modal" style="width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Login to <span id="auth-service-name">Gmail</span></h2>
        <button class="modal-close" onclick="closeAuthModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
          Google blocks sign-in from embedded apps. To use Gmail in Social Hub:
        </p>
        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 16px; display: flex; flex-direction: column; gap: 12px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--accent-gmail); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">1</div>
            <span style="font-size: 13px;">Click below to login in your browser</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--accent-gmail); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">2</div>
            <span style="font-size: 13px;">Complete the Google sign-in</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--accent-gmail); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">3</div>
            <span style="font-size: 13px;">Come back and click "Import Session"</span>
          </div>
        </div>
        <button class="btn-primary" onclick="openBrowserLogin()" style="background: var(--accent-gmail);">
          Open Browser Login
        </button>
        <button class="btn-secondary" onclick="importSessionAndCreate()">
          Import Session & Add Tab
        </button>
        <p style="font-size: 11px; color: var(--text-muted); text-align: center;">
          Works with Chrome, Firefox, and Chromium-based browsers
        </p>
      </div>
    </div>
  </div>

  <!-- Email Setup Modal -->
  <div class="modal-overlay" id="email-setup-modal">
    <div class="modal" style="width: 440px;">
      <div class="modal-header">
        <h2 class="modal-title">Setup Email Account</h2>
        <button class="modal-close" onclick="closeEmailSetupModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div class="form-group">
          <label class="form-label">Email Provider</label>
          <select class="form-select" id="email-provider" onchange="onProviderChange()">
            <option value="gmail">Gmail</option>
            <option value="outlook">Outlook / Hotmail</option>
            <option value="yahoo">Yahoo Mail</option>
            <option value="icloud">iCloud Mail</option>
            <option value="custom">Custom IMAP/SMTP</option>
          </select>
        </div>
        <p id="provider-note" style="font-size: 11px; color: var(--text-muted); background: var(--bg-tertiary); padding: 10px; border-radius: 6px;">
          Requires App Password (enable 2FA first)
        </p>
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-input" id="email-address" placeholder="you@gmail.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password / App Password</label>
          <input type="password" class="form-input" id="email-password" placeholder="App-specific password">
        </div>
        
        <!-- Custom server fields (hidden by default) -->
        <div id="custom-server-fields" style="display: none; flex-direction: column; gap: 16px;">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">IMAP Server</label>
              <input type="text" class="form-input" id="imap-host" placeholder="imap.example.com">
            </div>
            <div class="form-group" style="width: 100px;">
              <label class="form-label">Port</label>
              <input type="number" class="form-input" id="imap-port" value="993">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">SMTP Server</label>
              <input type="text" class="form-input" id="smtp-host" placeholder="smtp.example.com">
            </div>
            <div class="form-group" style="width: 100px;">
              <label class="form-label">Port</label>
              <input type="number" class="form-input" id="smtp-port" value="587">
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tab Name</label>
          <input type="text" class="form-input" id="email-tab-name" placeholder="Personal Gmail">
        </div>
        <div class="form-group">
          <label class="form-label">Group</label>
          <select class="form-select" id="email-group">
            <option value="default">Default</option>
            <option value="work">Work</option>
            <option value="personal">Personal</option>
          </select>
        </div>
        
        <div id="email-setup-error" style="display: none; color: #ef4444; font-size: 12px; padding: 10px; background: rgba(239,68,68,0.1); border-radius: 6px;"></div>
        
        <div style="display: flex; gap: 12px;">
          <button class="btn-secondary" onclick="testEmailConnection()" style="flex: 1;">Test Connection</button>
          <button class="btn-primary" onclick="addEmailAccount()" style="flex: 1; background: var(--accent-custom);">Add Account</button>
        </div>
        
        <p style="font-size: 11px; color: var(--text-muted); text-align: center;">
          <a href="#" onclick="electronAPI.openExternal('https://myaccount.google.com/apppasswords'); return false;" style="color: var(--accent-gmail);">How to get Gmail App Password</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Compose Email Modal -->
  <div class="compose-modal" id="compose-modal">
    <div class="compose-content">
      <div class="compose-header">
        <h3 id="compose-title">New Message</h3>
        <button class="compose-close" onclick="closeCompose()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="compose-body">
        <input type="hidden" id="compose-tab-id">
        <input type="hidden" id="compose-reply-to-id">
        <div class="compose-field">
          <label>To</label>
          <input type="email" id="compose-to" placeholder="recipient@example.com">
        </div>
        <div class="compose-field">
          <label>Cc</label>
          <input type="email" id="compose-cc" placeholder="cc@example.com (optional)">
        </div>
        <div class="compose-field">
          <label>Subject</label>
          <input type="text" id="compose-subject" placeholder="Subject">
        </div>
        <div class="compose-field">
          <label>Message</label>
          <textarea id="compose-body" placeholder="Write your message..."></textarea>
        </div>
      </div>
      <div class="compose-footer">
        <button class="compose-btn compose-btn-cancel" onclick="closeCompose()">Cancel</button>
        <button class="compose-btn compose-btn-send" onclick="sendComposedEmail()" id="compose-send-btn">Send</button>
      </div>
    </div>
  </div>

  <script>
    // Service configurations
    const services = {
      'messenger': {
        name: 'Messenger',
        url: 'https://www.messenger.com',
        icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.145 2 11.243c0 2.936 1.444 5.544 3.7 7.256v3.501l3.363-1.847c.898.248 1.85.382 2.837.382 5.523 0 10-4.145 10-9.243S17.523 2 12 2zm1.093 12.426l-2.547-2.72-4.97 2.72 5.467-5.803 2.612 2.72 4.905-2.72-5.467 5.803z"/></svg>`,
        defaultGroup: 'default'
      },
      'instagram-chat': {
        name: 'Instagram',
        url: 'https://www.instagram.com/direct/inbox/',
        icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="4"/><circle cx="18" cy="6" r="1.5" fill="currentColor"/></svg>`,
        defaultGroup: 'default'
      },
      'instagram-stats': {
        name: 'IG Analytics',
        url: 'https://www.instagram.com/accounts/insights/',
        icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>`,
        defaultGroup: 'default'
      },
      'tiktok': {
        name: 'TikTok',
        url: 'https://www.tiktok.com/analytics',
        icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>`,
        defaultGroup: 'default'
      },
      'gmail': {
        name: 'Gmail',
        url: 'https://mail.google.com',
        icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/></svg>`,
        defaultGroup: 'default',
        comingSoon: true
      },
      'email-imap': {
        name: 'Email',
        url: '',
        icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
        defaultGroup: 'default',
        isEmail: true
      },
      'outlook': {
        name: 'Outlook',
        url: 'https://outlook.live.com/mail/',
        icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 7.387v10.478c0 .23-.08.424-.238.576-.158.154-.352.23-.58.23h-8.547v-6.959l1.6 1.18c.106.077.236.116.388.116.152 0 .283-.04.39-.116l6.87-5.1c.095-.063.166-.063.214 0 .047.063.047.148 0 .254l-.097.341zm-.818-1.06c0-.167-.044-.247-.133-.24-.09.006-.2.073-.332.2l-7.127 5.298-1.954-1.442V7.387c0-.23-.08-.424-.238-.576-.158-.153-.352-.23-.58-.23H7.636v14.838h14.546c.228 0 .422-.077.58-.23.158-.152.238-.346.238-.577V6.328zM7.091 3.844c0-.307-.1-.557-.299-.75-.2-.193-.463-.29-.79-.29H.79c-.327 0-.59.097-.79.29-.2.193-.3.443-.3.75v14.52c0 .306.1.556.3.75.2.192.463.289.79.289h5.21V3.844zm.545 8.66c0-1.14-.298-2.06-.894-2.759-.597-.699-1.391-1.049-2.381-1.049-.99 0-1.784.35-2.38 1.049-.598.7-.897 1.62-.897 2.76s.299 2.06.896 2.759c.597.699 1.39 1.048 2.381 1.048s1.784-.35 2.38-1.048c.597-.7.895-1.62.895-2.76zm-2.198 0c0 .615-.105 1.084-.316 1.408-.21.324-.513.486-.907.486-.394 0-.697-.162-.908-.486-.21-.324-.316-.793-.316-1.408s.105-1.085.316-1.408c.21-.324.514-.486.908-.486.394 0 .696.162.907.486.21.323.316.793.316 1.408z"/></svg>`,
        defaultGroup: 'default'
      },
      'custom': {
        name: 'Custom',
        url: '',
        icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>`,
        defaultGroup: 'default'
      }
    };

    const groupNames = {
      'default': 'General',
      'work': 'Work',
      'personal': 'Personal'
    };

    // State
    let tabs = [];
    let activeTabId = null;
    let contextTabId = null;
    let renameTabId = null;

    // Initialize
    async function init() {
      tabs = await electronAPI.getStoredTabs() || [];
      renderTabs();
      if (tabs.length > 0) {
        setActiveTab(tabs[0].id);
      }
      
      // Auto-reconnect email accounts
      for (const tab of tabs) {
        if (tab.type === 'email-imap') {
          reconnectEmail(tab.id);
        }
      }
    }
    
    // Reconnect email account from saved config
    async function reconnectEmail(tabId) {
      try {
        const config = await electronAPI.getEmailConfig(tabId);
        if (config) {
          const result = await electronAPI.connectEmail(tabId, config);
          if (result.success) {
            // Reload emails after reconnect
            setTimeout(() => loadEmails(tabId), 500);
          } else {
            console.log('Failed to reconnect email:', result.error);
            // Show reconnect prompt in UI
            showReconnectPrompt(tabId);
          }
        }
      } catch (e) {
        console.log('Email reconnect error:', e);
      }
    }
    
    // Show reconnect prompt for failed email connection
    function showReconnectPrompt(tabId) {
      const listContainer = document.getElementById(`email-list-${tabId}`);
      if (listContainer) {
        listContainer.innerHTML = `
          <div class="email-loading" style="flex-direction: column; gap: 12px;">
            <span>Session expired</span>
            <button class="btn-primary" onclick="showEmailReconnect('${tabId}')" style="padding: 8px 16px; font-size: 12px;">
              Reconnect
            </button>
          </div>
        `;
      }
    }
    
    function showEmailReconnect(tabId) {
      // For now, remove and re-add - could make a nicer reconnect modal later
      const tab = tabs.find(t => t.id === tabId);
      if (tab && tab.emailConfig) {
        alert('Please remove this email tab and add it again to reconnect.');
      }
    }

    // Generate unique ID
    function generateId() {
      return `tab-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    // Add new tab
    async function addTab(serviceType) {
      const service = services[serviceType];
      
      // If coming soon, show message
      if (service.comingSoon) {
        showComingSoon(service.name);
        return;
      }
      
      // If service is marked as external, open in default browser
      if (service.external) {
        electronAPI.openExternal(service.url);
        closeAddModal();
        return;
      }
      
      // If service is email (IMAP), show email setup modal
      if (service.isEmail) {
        showEmailSetupModal();
        return;
      }
      
      // If service requires special auth (like Gmail), show auth modal
      if (service.requiresAuth) {
        showAuthModal(serviceType);
        return;
      }
      
      const id = generateId();
      const partition = await electronAPI.createTabSession(id);
      
      const tab = {
        id,
        type: serviceType,
        name: service.name,
        url: service.url,
        group: service.defaultGroup,
        partition,
        badge: 0
      };
      
      tabs.push(tab);
      saveTabs();
      renderTabs();
      setActiveTab(id);
      closeAddModal();
    }
    
    // Coming soon message
    function showComingSoon(name) {
      alert(`${name} is coming soon! For now, use the "Email (IMAP)" option which works with Gmail using an App Password.`);
    }
    
    // Auth modal for services like Gmail
    let pendingAuthService = null;
    
    function showAuthModal(serviceType) {
      pendingAuthService = serviceType;
      const service = services[serviceType];
      document.getElementById('auth-service-name').textContent = service.name;
      document.getElementById('auth-modal').classList.add('active');
      closeAddModal();
    }
    
    function closeAuthModal() {
      document.getElementById('auth-modal').classList.remove('active');
      pendingAuthService = null;
    }
    
    function openBrowserLogin() {
      if (pendingAuthService) {
        const service = services[pendingAuthService];
        electronAPI.openExternal(service.authUrl);
      }
    }
    
    async function importSessionAndCreate() {
      if (!pendingAuthService) return;
      
      const service = services[pendingAuthService];
      const id = generateId();
      const partition = await electronAPI.createTabSession(id);
      
      // Request cookie import from main process
      const success = await electronAPI.importBrowserCookies(partition, 'google.com');
      
      if (!success) {
        alert('Could not import cookies. Make sure you are logged into Gmail in Chrome or Firefox, then try again.');
        return;
      }
      
      const tab = {
        id,
        type: pendingAuthService,
        name: service.name,
        url: service.url,
        group: service.defaultGroup,
        partition,
        badge: 0
      };
      
      tabs.push(tab);
      saveTabs();
      renderTabs();
      setActiveTab(id);
      closeAuthModal();
    }

    // Email setup modal functions
    const emailPresets = {
      'gmail': {
        imap: { host: 'imap.gmail.com', port: 993 },
        smtp: { host: 'smtp.gmail.com', port: 587 },
        note: 'Requires App Password (enable 2FA first)'
      },
      'outlook': {
        imap: { host: 'outlook.office365.com', port: 993 },
        smtp: { host: 'smtp.office365.com', port: 587 },
        note: 'Use your regular password or App Password'
      },
      'yahoo': {
        imap: { host: 'imap.mail.yahoo.com', port: 993 },
        smtp: { host: 'smtp.mail.yahoo.com', port: 587 },
        note: 'Requires App Password'
      },
      'icloud': {
        imap: { host: 'imap.mail.me.com', port: 993 },
        smtp: { host: 'smtp.mail.me.com', port: 587 },
        note: 'Requires App-Specific Password'
      },
      'custom': {
        imap: { host: '', port: 993 },
        smtp: { host: '', port: 587 },
        note: 'Enter your server details manually'
      }
    };

    function showEmailSetupModal() {
      document.getElementById('email-setup-modal').classList.add('active');
      closeAddModal();
      onProviderChange(); // Initialize with Gmail preset
    }

    function closeEmailSetupModal() {
      document.getElementById('email-setup-modal').classList.remove('active');
      document.getElementById('email-setup-error').style.display = 'none';
      // Clear form
      document.getElementById('email-address').value = '';
      document.getElementById('email-password').value = '';
      document.getElementById('email-tab-name').value = '';
    }

    function onProviderChange() {
      const provider = document.getElementById('email-provider').value;
      const preset = emailPresets[provider];
      const customFields = document.getElementById('custom-server-fields');
      
      document.getElementById('provider-note').textContent = preset.note;
      
      if (provider === 'custom') {
        customFields.style.display = 'flex';
      } else {
        customFields.style.display = 'none';
        document.getElementById('imap-host').value = preset.imap.host;
        document.getElementById('imap-port').value = preset.imap.port;
        document.getElementById('smtp-host').value = preset.smtp.host;
        document.getElementById('smtp-port').value = preset.smtp.port;
      }
    }

    function getEmailConfig() {
      const provider = document.getElementById('email-provider').value;
      const preset = emailPresets[provider];
      
      return {
        email: document.getElementById('email-address').value.trim(),
        password: document.getElementById('email-password').value,
        imap: {
          host: provider === 'custom' ? document.getElementById('imap-host').value : preset.imap.host,
          port: parseInt(provider === 'custom' ? document.getElementById('imap-port').value : preset.imap.port),
          tls: true
        },
        smtp: {
          host: provider === 'custom' ? document.getElementById('smtp-host').value : preset.smtp.host,
          port: parseInt(provider === 'custom' ? document.getElementById('smtp-port').value : preset.smtp.port),
          secure: false
        }
      };
    }

    async function testEmailConnection() {
      const config = getEmailConfig();
      const errorDiv = document.getElementById('email-setup-error');
      
      if (!config.email || !config.password) {
        errorDiv.textContent = 'Please enter email and password';
        errorDiv.style.display = 'block';
        return;
      }
      
      errorDiv.textContent = 'Testing connection...';
      errorDiv.style.display = 'block';
      errorDiv.style.color = 'var(--text-secondary)';
      errorDiv.style.background = 'var(--bg-tertiary)';
      
      try {
        const result = await electronAPI.testEmailConnection(config);
        if (result.success) {
          errorDiv.textContent = 'âœ“ Connection successful!';
          errorDiv.style.color = '#10b981';
          errorDiv.style.background = 'rgba(16,185,129,0.1)';
        } else {
          errorDiv.textContent = `Connection failed: ${result.error}`;
          errorDiv.style.color = '#ef4444';
          errorDiv.style.background = 'rgba(239,68,68,0.1)';
        }
      } catch (e) {
        errorDiv.textContent = `Error: ${e.message}`;
        errorDiv.style.color = '#ef4444';
        errorDiv.style.background = 'rgba(239,68,68,0.1)';
      }
    }

    async function addEmailAccount() {
      const config = getEmailConfig();
      const tabName = document.getElementById('email-tab-name').value.trim() || config.email.split('@')[0];
      const group = document.getElementById('email-group').value;
      const errorDiv = document.getElementById('email-setup-error');
      
      if (!config.email || !config.password) {
        errorDiv.textContent = 'Please enter email and password';
        errorDiv.style.display = 'block';
        errorDiv.style.color = '#ef4444';
        errorDiv.style.background = 'rgba(239,68,68,0.1)';
        return;
      }
      
      errorDiv.textContent = 'Connecting...';
      errorDiv.style.display = 'block';
      errorDiv.style.color = 'var(--text-secondary)';
      errorDiv.style.background = 'var(--bg-tertiary)';
      
      const id = generateId();
      
      try {
        const result = await electronAPI.connectEmail(id, config);
        
        if (result.success) {
          const tab = {
            id,
            type: 'email-imap',
            name: tabName,
            url: '',
            group,
            partition: `email-${id}`,
            badge: 0,
            emailConfig: {
              email: config.email,
              provider: document.getElementById('email-provider').value
            }
          };
          
          tabs.push(tab);
          saveTabs();
          renderTabs();
          setActiveTab(id);
          closeEmailSetupModal();
        } else {
          errorDiv.textContent = `Failed to connect: ${result.error}`;
          errorDiv.style.color = '#ef4444';
          errorDiv.style.background = 'rgba(239,68,68,0.1)';
        }
      } catch (e) {
        errorDiv.textContent = `Error: ${e.message}`;
        errorDiv.style.color = '#ef4444';
        errorDiv.style.background = 'rgba(239,68,68,0.1)';
      }
    }

    // Add custom tab
    async function addCustomTab() {
      const name = document.getElementById('custom-name').value.trim();
      const url = document.getElementById('custom-url').value.trim();
      const group = document.getElementById('custom-group').value;

      if (!name || !url) {
        alert('Please fill in all fields');
        return;
      }

      // Ensure URL has protocol
      let finalUrl = url;
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        finalUrl = 'https://' + url;
      }

      const id = generateId();
      const partition = await electronAPI.createTabSession(id);

      const tab = {
        id,
        type: 'custom',
        name,
        url: finalUrl,
        group,
        partition,
        badge: 0
      };

      tabs.push(tab);
      saveTabs();
      renderTabs();
      setActiveTab(id);
      closeAddModal();
      hideCustomForm();

      // Clear form
      document.getElementById('custom-name').value = '';
      document.getElementById('custom-url').value = '';
      document.getElementById('custom-group').value = 'default';
    }

    // Remove tab
    function removeTab(id, event) {
      if (event) event.stopPropagation();
      electronAPI.removeTabSession(id);
      tabs = tabs.filter(t => t.id !== id);
      saveTabs();
      
      if (activeTabId === id) {
        activeTabId = tabs.length > 0 ? tabs[0].id : null;
      }
      
      renderTabs();
      if (activeTabId) {
        setActiveTab(activeTabId);
      }
    }

    // Set active tab
    function setActiveTab(id) {
      activeTabId = id;
      
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.id === id);
      });
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.dataset.id === id);
      });
      
      const welcome = document.getElementById('welcome-screen');
      welcome.style.display = tabs.length === 0 ? 'flex' : 'none';
    }

    // Get tabs organized by group
    function getTabsByGroup() {
      const groups = {};
      tabs.forEach((tab, index) => {
        const group = tab.group || 'default';
        if (!groups[group]) groups[group] = [];
        groups[group].push({ ...tab, index });
      });
      return groups;
    }

    // Render tabs
    function renderTabs() {
      const groupContainer = document.getElementById('tab-groups');
      const contentContainer = document.getElementById('tab-contents');
      
      groupContainer.innerHTML = '';
      contentContainer.querySelectorAll('.tab-content').forEach(el => el.remove());
      
      const tabsByGroup = getTabsByGroup();
      const groupOrder = ['default', 'work', 'personal'];
      
      let globalIndex = 0;
      
      groupOrder.forEach(groupId => {
        const groupTabs = tabsByGroup[groupId];
        if (!groupTabs || groupTabs.length === 0) return;
        
        const groupDiv = document.createElement('div');
        groupDiv.className = 'tab-group';
        
        // Only show group header if more than one group has tabs
        const activeGroups = groupOrder.filter(g => tabsByGroup[g] && tabsByGroup[g].length > 0);
        if (activeGroups.length > 1) {
          const header = document.createElement('div');
          header.className = 'tab-group-header';
          header.textContent = groupNames[groupId];
          groupDiv.appendChild(header);
        }
        
        const tabsDiv = document.createElement('div');
        tabsDiv.className = 'tab-group-tabs';
        
        groupTabs.forEach(tab => {
          globalIndex++;
          const service = services[tab.type];
          const icon = tab.type === 'custom' || tab.type === 'email-imap' ? service.icon : service.icon;
          
          // Button
          const button = document.createElement('button');
          button.className = `tab-button ${tab.type}`;
          button.dataset.id = tab.id;
          button.onclick = () => setActiveTab(tab.id);
          button.oncontextmenu = (e) => showContextMenu(e, tab.id);
          button.innerHTML = `
            ${icon}
            <span class="tab-badge ${tab.badge > 0 ? 'visible' : ''}">${tab.badge}</span>
            ${globalIndex <= 9 ? `<span class="tab-number">${globalIndex}</span>` : ''}
            <span class="close-tab" onclick="removeTab('${tab.id}', event)">Ã—</span>
          `;
          tabsDiv.appendChild(button);
          
          // Content - different for email vs webview tabs
          const content = document.createElement('div');
          content.className = 'tab-content';
          content.dataset.id = tab.id;
          
          if (tab.type === 'email-imap') {
            // Email UI
            content.innerHTML = `
              <div class="email-container">
                <div class="email-sidebar">
                  <div class="email-account-info">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--accent-custom);">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                      <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    <span>${tab.name}</span>
                  </div>
                  <div class="email-folders" id="folders-${tab.id}">
                    <div class="email-folder active" onclick="loadFolder('${tab.id}', 'INBOX')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-6l-2 3h-4l-2-3H2"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
                      Inbox
                    </div>
                    <div class="email-folder" onclick="loadFolder('${tab.id}', '[Gmail]/Sent Mail')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                      Sent
                    </div>
                    <div class="email-folder" onclick="loadFolder('${tab.id}', '[Gmail]/Drafts')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                      Drafts
                    </div>
                    <div class="email-folder" onclick="loadFolder('${tab.id}', '[Gmail]/Trash')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                      Trash
                    </div>
                  </div>
                  <button class="compose-btn" onclick="showCompose('${tab.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Compose
                  </button>
                </div>
                <div class="email-list" id="email-list-${tab.id}">
                  <div class="email-loading">Loading emails...</div>
                </div>
                <div class="email-viewer" id="email-viewer-${tab.id}">
                  <div class="email-placeholder">Select an email to read</div>
                </div>
              </div>
            `;
            contentContainer.appendChild(content);
            
            // Load emails after a short delay
            setTimeout(() => initEmailTab(tab.id), 500);
          } else {
            // Regular webview
            content.innerHTML = `
              <div class="webview-wrapper">
                <div class="webview-toolbar">
                  <button class="nav-btn" onclick="navigateBack('${tab.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                  </button>
                  <button class="nav-btn" onclick="navigateForward('${tab.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                  </button>
                  <button class="nav-btn" onclick="reloadTab('${tab.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M23 4v6h-6M1 20v-6h6"/>
                      <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                    </svg>
                  </button>
                  <div class="url-display" id="url-${tab.id}">${tab.url}</div>
                  <span class="tab-label ${tab.type}" onclick="openRenameModal('${tab.id}')">${tab.name}</span>
                </div>
                <webview 
                  id="webview-${tab.id}"
                  src="${tab.url}"
                  partition="${tab.partition}"
                  allowpopups
                  useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
                ></webview>
              </div>
            `;
            contentContainer.appendChild(content);
            
            // Setup webview events
            const webview = content.querySelector('webview');
            if (webview) {
              webview.addEventListener('did-navigate', (e) => {
                document.getElementById(`url-${tab.id}`).textContent = e.url;
              });
              webview.addEventListener('did-navigate-in-page', (e) => {
                document.getElementById(`url-${tab.id}`).textContent = e.url;
              });
              
              // Listen for title changes (for notification badges)
              webview.addEventListener('page-title-updated', (e) => {
                const match = e.title.match(/^\((\d+)\)/);
                if (match) {
                  updateBadge(tab.id, parseInt(match[1]));
                } else {
                  updateBadge(tab.id, 0);
                }
              });
            }
          }
        });
        
        groupDiv.appendChild(tabsDiv);
        groupContainer.appendChild(groupDiv);
      });
      
      const welcome = document.getElementById('welcome-screen');
      welcome.style.display = tabs.length === 0 ? 'flex' : 'none';
    }

    // Update notification badge
    function updateBadge(tabId, count) {
      const tab = tabs.find(t => t.id === tabId);
      if (tab) {
        tab.badge = count;
        const badge = document.querySelector(`.tab-button[data-id="${tabId}"] .tab-badge`);
        if (badge) {
          badge.textContent = count;
          badge.classList.toggle('visible', count > 0);
        }
      }
    }

    // Navigation functions
    function navigateBack(tabId) {
      const webview = document.getElementById(`webview-${tabId}`);
      if (webview && webview.canGoBack()) webview.goBack();
    }

    function navigateForward(tabId) {
      const webview = document.getElementById(`webview-${tabId}`);
      if (webview && webview.canGoForward()) webview.goForward();
    }

    function reloadTab(tabId) {
      const webview = document.getElementById(`webview-${tabId}`);
      if (webview) webview.reload();
    }

    // Modal functions
    function openAddModal() {
      document.getElementById('add-modal').classList.add('active');
      hideCustomForm();
    }

    function closeAddModal() {
      document.getElementById('add-modal').classList.remove('active');
      hideCustomForm();
    }

    function showCustomForm() {
      document.getElementById('custom-form').classList.add('active');
    }

    function hideCustomForm() {
      document.getElementById('custom-form').classList.remove('active');
    }

    // Rename modal
    function openRenameModal(tabId) {
      renameTabId = tabId;
      const tab = tabs.find(t => t.id === tabId);
      if (tab) {
        document.getElementById('rename-input').value = tab.name;
        document.getElementById('rename-group').value = tab.group || 'default';
        document.getElementById('rename-modal').classList.add('active');
        document.getElementById('rename-input').focus();
      }
    }

    function closeRenameModal() {
      document.getElementById('rename-modal').classList.remove('active');
      renameTabId = null;
    }

    function saveRename() {
      if (!renameTabId) return;
      const newName = document.getElementById('rename-input').value.trim();
      const newGroup = document.getElementById('rename-group').value;
      
      if (newName) {
        const tab = tabs.find(t => t.id === renameTabId);
        if (tab) {
          tab.name = newName;
          tab.group = newGroup;
          saveTabs();
          renderTabs();
          setActiveTab(activeTabId);
        }
      }
      closeRenameModal();
    }

    // Context menu
    function showContextMenu(e, tabId) {
      e.preventDefault();
      contextTabId = tabId;
      const menu = document.getElementById('context-menu');
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      menu.classList.add('active');
    }

    function hideContextMenu() {
      document.getElementById('context-menu').classList.remove('active');
      contextTabId = null;
    }

    function renameCurrentTab() {
      if (contextTabId) {
        openRenameModal(contextTabId);
      }
      hideContextMenu();
    }

    function changeGroup() {
      if (contextTabId) {
        openRenameModal(contextTabId);
      }
      hideContextMenu();
    }

    function reloadCurrentTab() {
      if (contextTabId) {
        reloadTab(contextTabId);
      }
      hideContextMenu();
    }

    function closeCurrentTab() {
      if (contextTabId) {
        removeTab(contextTabId);
      }
      hideContextMenu();
    }

    // Save tabs
    function saveTabs() {
      electronAPI.saveTabs(tabs.map(t => ({
        id: t.id,
        type: t.type,
        name: t.name,
        url: t.url,
        group: t.group,
        partition: t.partition,
        badge: 0
      })));
    }

    // Event listeners
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.context-menu')) {
        hideContextMenu();
      }
      if (e.target.classList.contains('modal-overlay')) {
        if (e.target.id === 'add-modal') closeAddModal();
        if (e.target.id === 'rename-modal') closeRenameModal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Escape - close modals
      if (e.key === 'Escape') {
        closeAddModal();
        closeRenameModal();
        hideContextMenu();
      }
      
      // Ctrl+N - new tab
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        openAddModal();
      }
      
      // Ctrl+W - close current tab
      if (e.ctrlKey && e.key === 'w') {
        e.preventDefault();
        if (activeTabId) {
          removeTab(activeTabId);
        }
      }
      
      // Ctrl+R - reload current tab
      if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        if (activeTabId) {
          reloadTab(activeTabId);
        }
      }
      
      // Ctrl+1-9 - switch tabs
      if (e.ctrlKey && e.key >= '1' && e.key <= '9') {
        e.preventDefault();
        const index = parseInt(e.key) - 1;
        if (index < tabs.length) {
          setActiveTab(tabs[index].id);
        }
      }
      
      // Ctrl+Tab - next tab
      if (e.ctrlKey && e.key === 'Tab') {
        e.preventDefault();
        const currentIndex = tabs.findIndex(t => t.id === activeTabId);
        const nextIndex = e.shiftKey 
          ? (currentIndex - 1 + tabs.length) % tabs.length
          : (currentIndex + 1) % tabs.length;
        if (tabs[nextIndex]) {
          setActiveTab(tabs[nextIndex].id);
        }
      }
      
      // Enter in rename modal
      if (e.key === 'Enter' && document.getElementById('rename-modal').classList.contains('active')) {
        saveRename();
      }
    });

    // Email client functions
    let currentEmails = {};
    let selectedEmailId = {};
    let currentFolder = {};

    // Try to reconnect email on load
    async function initEmailTab(tabId) {
      const listContainer = document.getElementById(`email-list-${tabId}`);
      if (!listContainer) return;
      
      listContainer.innerHTML = '<div class="email-loading">Connecting...</div>';
      
      // Check if already connected
      const isConnected = await electronAPI.isEmailConnected(tabId);
      
      if (!isConnected) {
        // Try to reconnect using saved credentials
        const result = await electronAPI.reconnectEmail(tabId);
        if (!result.success) {
          listContainer.innerHTML = `
            <div class="email-loading">
              <p>Not connected</p>
              <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">
                Session expired. Please remove this tab and add your email account again.
              </p>
            </div>
          `;
          return;
        }
      }
      
      // Load folders then emails
      await loadFolders(tabId);
      await loadEmails(tabId, 'INBOX');
    }

    async function loadFolders(tabId) {
      try {
        const result = await electronAPI.getMailboxes(tabId);
        if (result.success) {
          renderFolders(tabId, result.mailboxes);
        }
      } catch (e) {
        console.error('Failed to load folders:', e);
      }
    }

    function renderFolders(tabId, mailboxes) {
      const foldersContainer = document.getElementById(`folders-${tabId}`);
      if (!foldersContainer) return;
      
      // Find common folders
      const findFolder = (names) => {
        for (const name of names) {
          const found = mailboxes.find(m => 
            m.path.toLowerCase() === name.toLowerCase() ||
            m.name.toLowerCase() === name.toLowerCase()
          );
          if (found) return found.path;
        }
        return null;
      };
      
      const inbox = 'INBOX';
      const sent = findFolder(['[Gmail]/Sent Mail', 'Sent', 'INBOX.Sent', 'Sent Items', 'Sent Messages']);
      const drafts = findFolder(['[Gmail]/Drafts', 'Drafts', 'INBOX.Drafts', 'Draft']);
      const trash = findFolder(['[Gmail]/Trash', 'Trash', 'INBOX.Trash', 'Deleted Items', 'Deleted']);
      const spam = findFolder(['[Gmail]/Spam', 'Spam', 'INBOX.Spam', 'Junk', 'Junk E-mail']);
      const starred = findFolder(['[Gmail]/Starred', 'Starred', 'Flagged']);
      
      let html = `
        <div class="email-folder active" onclick="loadFolder('${tabId}', 'INBOX')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-6l-2 3h-4l-2-3H2"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
          Inbox
        </div>
      `;
      
      if (starred) {
        html += `
          <div class="email-folder" onclick="loadFolder('${tabId}', '${starred}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            Starred
          </div>
        `;
      }
      
      if (sent) {
        html += `
          <div class="email-folder" onclick="loadFolder('${tabId}', '${sent}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            Sent
          </div>
        `;
      }
      
      if (drafts) {
        html += `
          <div class="email-folder" onclick="loadFolder('${tabId}', '${drafts}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Drafts
          </div>
        `;
      }
      
      if (spam) {
        html += `
          <div class="email-folder" onclick="loadFolder('${tabId}', '${spam}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            Spam
          </div>
        `;
      }
      
      if (trash) {
        html += `
          <div class="email-folder" onclick="loadFolder('${tabId}', '${trash}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Trash
          </div>
        `;
      }
      
      foldersContainer.innerHTML = html;
    }

    async function loadEmails(tabId, folder = 'INBOX') {
      const listContainer = document.getElementById(`email-list-${tabId}`);
      if (!listContainer) return;
      
      currentFolder[tabId] = folder;
      listContainer.innerHTML = '<div class="email-loading">Loading emails...</div>';
      
      // Clear viewer
      const viewer = document.getElementById(`email-viewer-${tabId}`);
      if (viewer) {
        viewer.innerHTML = '<div class="email-placeholder">Select an email to read</div>';
      }
      
      try {
        const result = await electronAPI.getEmails(tabId, folder, 100);
        
        if (result.success) {
          currentEmails[tabId] = result.emails;
          renderEmailList(tabId);
        } else {
          listContainer.innerHTML = `<div class="email-loading" style="color: #ef4444;">Error: ${result.error}</div>`;
        }
      } catch (e) {
        listContainer.innerHTML = `<div class="email-loading" style="color: #ef4444;">Failed to load emails</div>`;
      }
    }

    function loadFolder(tabId, folder) {
      // Update folder selection UI
      const folders = document.querySelectorAll(`#folders-${tabId} .email-folder`);
      folders.forEach(f => f.classList.remove('active'));
      if (event && event.target) {
        const folderEl = event.target.closest('.email-folder');
        if (folderEl) folderEl.classList.add('active');
      }
      
      loadEmails(tabId, folder);
    }

    function renderEmailList(tabId) {
      const listContainer = document.getElementById(`email-list-${tabId}`);
      const emails = currentEmails[tabId] || [];
      
      if (emails.length === 0) {
        listContainer.innerHTML = '<div class="email-loading">No emails in this folder</div>';
        return;
      }
      
      listContainer.innerHTML = emails.map(email => {
        const dateStr = formatDate(email.date);
        const preview = (email.text || '').substring(0, 80).replace(/\n/g, ' ');
        
        return `
          <div class="email-item ${email.isRead ? '' : 'unread'} ${email.isStarred ? 'starred' : ''}" data-uid="${email.uid}" onclick="selectEmail('${tabId}', ${email.uid})">
            <span class="email-item-date">${dateStr}</span>
            <div class="email-item-actions">
              <button class="email-action-btn" onclick="event.stopPropagation(); toggleStarEmail('${tabId}', ${email.uid}, ${!email.isStarred})" title="${email.isStarred ? 'Unstar' : 'Star'}">
                <svg viewBox="0 0 24 24" fill="${email.isStarred ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              </button>
              <button class="email-action-btn" onclick="event.stopPropagation(); archiveEmailAction('${tabId}', ${email.uid})" title="Archive">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/></svg>
              </button>
              <button class="email-action-btn" onclick="event.stopPropagation(); trashEmailAction('${tabId}', ${email.uid})" title="Delete">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
            <div class="email-item-from">${email.isStarred ? 'â­ ' : ''}${escapeHtml(email.from)}</div>
            <div class="email-item-subject">${escapeHtml(email.subject)}${email.hasAttachments ? ' ðŸ“Ž' : ''}</div>
            <div class="email-item-preview">${escapeHtml(preview)}</div>
          </div>
        `;
      }).join('');
    }

    function selectEmail(tabId, uid) {
      const emails = currentEmails[tabId] || [];
      const email = emails.find(e => e.uid == uid);
      if (!email) return;
      
      selectedEmailId[tabId] = uid;
      
      const items = document.querySelectorAll(`#email-list-${tabId} .email-item`);
      items.forEach(item => item.classList.toggle('active', item.dataset.uid == uid));
      
      let dateStr = 'Unknown date';
      try {
        const d = new Date(email.date);
        if (!isNaN(d.getTime())) dateStr = d.toLocaleString();
      } catch (e) {}
      
      const viewer = document.getElementById(`email-viewer-${tabId}`);
      
      let content = '';
      if (email.html) {
        content = email.html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
      } else if (email.text) {
        content = `<pre style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(email.text)}</pre>`;
      } else {
        content = '<p style="color: var(--text-muted);">No content</p>';
      }
      
      viewer.innerHTML = `
        <div class="email-toolbar">
          <button class="email-toolbar-btn primary" onclick="replyToEmail('${tabId}', ${uid})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg>
            Reply
          </button>
          <button class="email-toolbar-btn" onclick="forwardEmail('${tabId}', ${uid})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 17 20 12 15 7"/><path d="M4 18v-2a4 4 0 0 1 4-4h12"/></svg>
            Forward
          </button>
          <div class="email-toolbar-divider"></div>
          <button class="email-toolbar-btn" onclick="archiveEmailAction('${tabId}', ${uid})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/></svg>
            Archive
          </button>
          <button class="email-toolbar-btn" onclick="spamEmailAction('${tabId}', ${uid})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
            Spam
          </button>
          <button class="email-toolbar-btn danger" onclick="trashEmailAction('${tabId}', ${uid})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Delete
          </button>
          <div class="email-toolbar-divider"></div>
          <button class="email-toolbar-btn" onclick="toggleReadStatus('${tabId}', ${uid}, ${email.isRead})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            ${email.isRead ? 'Unread' : 'Read'}
          </button>
          <button class="email-toolbar-btn" onclick="toggleStarEmail('${tabId}', ${uid}, ${!email.isStarred})">
            <svg viewBox="0 0 24 24" fill="${email.isStarred ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            ${email.isStarred ? 'Unstar' : 'Star'}
          </button>
        </div>
        <div class="email-header">
          <div class="email-subject">${escapeHtml(email.subject)}</div>
          <div class="email-meta">
            <span><strong>From:</strong> ${escapeHtml(email.fromFull || email.from)}</span>
            <span><strong>Date:</strong> ${dateStr}</span>
          </div>
          ${email.to ? `<div class="email-meta"><span><strong>To:</strong> ${escapeHtml(email.to)}</span></div>` : ''}
          ${email.cc ? `<div class="email-meta"><span><strong>Cc:</strong> ${escapeHtml(email.cc)}</span></div>` : ''}
          ${email.hasAttachments ? `<div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">ðŸ“Ž ${email.attachments.map(a => a.filename).join(', ')}</div>` : ''}
        </div>
        <div class="email-body">${content}</div>
      `;
      
      if (!email.isRead) {
        electronAPI.markEmailRead(tabId, uid, currentFolder[tabId]);
        email.isRead = true;
        const item = document.querySelector(`#email-list-${tabId} .email-item[data-uid="${uid}"]`);
        if (item) item.classList.remove('unread');
      }
    }

    function showCompose(tabId, replyTo = null, forward = null) {
      document.getElementById('compose-modal').classList.add('active');
      document.getElementById('compose-tab-id').value = tabId;
      document.getElementById('compose-reply-to-id').value = replyTo?.id || '';
      document.getElementById('compose-cc').value = '';
      
      if (replyTo) {
        document.getElementById('compose-title').textContent = 'Reply';
        document.getElementById('compose-to').value = replyTo.replyTo || replyTo.fromEmail || '';
        document.getElementById('compose-subject').value = replyTo.subject.startsWith('Re:') ? replyTo.subject : `Re: ${replyTo.subject}`;
        document.getElementById('compose-body').value = `\n\n--- Original Message ---\nFrom: ${replyTo.fromFull}\nDate: ${new Date(replyTo.date).toLocaleString()}\n\n${replyTo.text || ''}`;
      } else if (forward) {
        document.getElementById('compose-title').textContent = 'Forward';
        document.getElementById('compose-to').value = '';
        document.getElementById('compose-subject').value = forward.subject.startsWith('Fwd:') ? forward.subject : `Fwd: ${forward.subject}`;
        document.getElementById('compose-body').value = `\n\n--- Forwarded Message ---\nFrom: ${forward.fromFull}\nDate: ${new Date(forward.date).toLocaleString()}\nSubject: ${forward.subject}\n\n${forward.text || ''}`;
      } else {
        document.getElementById('compose-title').textContent = 'New Message';
        document.getElementById('compose-to').value = '';
        document.getElementById('compose-subject').value = '';
        document.getElementById('compose-body').value = '';
      }
    }

    function closeCompose() {
      document.getElementById('compose-modal').classList.remove('active');
    }

    async function sendComposedEmail() {
      const tabId = document.getElementById('compose-tab-id').value;
      const to = document.getElementById('compose-to').value.trim();
      const cc = document.getElementById('compose-cc').value.trim();
      const subject = document.getElementById('compose-subject').value.trim();
      const body = document.getElementById('compose-body').value;
      
      if (!to) { alert('Please enter a recipient'); return; }
      
      const sendBtn = document.getElementById('compose-send-btn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      
      try {
        const result = await electronAPI.sendEmail(tabId, { to, cc, subject, text: body, html: body.replace(/\n/g, '<br>') });
        if (result.success) { closeCompose(); alert('Email sent!'); }
        else { alert('Failed: ' + result.error); }
      } catch (e) { alert('Error: ' + e.message); }
      finally { sendBtn.disabled = false; sendBtn.textContent = 'Send'; }
    }

    function replyToEmail(tabId, uid) {
      const email = (currentEmails[tabId] || []).find(e => e.uid == uid);
      if (email) showCompose(tabId, email, null);
    }

    function forwardEmail(tabId, uid) {
      const email = (currentEmails[tabId] || []).find(e => e.uid == uid);
      if (email) showCompose(tabId, null, email);
    }

    async function toggleReadStatus(tabId, uid, isRead) {
      try {
        if (isRead) await electronAPI.markEmailUnread(tabId, uid, currentFolder[tabId]);
        else await electronAPI.markEmailRead(tabId, uid, currentFolder[tabId]);
        const email = (currentEmails[tabId] || []).find(e => e.uid == uid);
        if (email) { email.isRead = !isRead; renderEmailList(tabId); selectEmail(tabId, uid); }
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function toggleStarEmail(tabId, uid, star) {
      try {
        if (star) await electronAPI.starEmail(tabId, uid, currentFolder[tabId]);
        else await electronAPI.unstarEmail(tabId, uid, currentFolder[tabId]);
        const email = (currentEmails[tabId] || []).find(e => e.uid == uid);
        if (email) { email.isStarred = star; renderEmailList(tabId); if (selectedEmailId[tabId] == uid) selectEmail(tabId, uid); }
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function archiveEmailAction(tabId, uid) {
      try {
        await electronAPI.archiveEmail(tabId, uid, currentFolder[tabId]);
        currentEmails[tabId] = (currentEmails[tabId] || []).filter(e => e.uid != uid);
        renderEmailList(tabId);
        document.getElementById(`email-viewer-${tabId}`).innerHTML = '<div class="email-placeholder">Email archived</div>';
      } catch (e) { alert('Archive failed: ' + e.message); }
    }

    async function trashEmailAction(tabId, uid) {
      try {
        await electronAPI.trashEmail(tabId, uid, currentFolder[tabId]);
        currentEmails[tabId] = (currentEmails[tabId] || []).filter(e => e.uid != uid);
        renderEmailList(tabId);
        document.getElementById(`email-viewer-${tabId}`).innerHTML = '<div class="email-placeholder">Email deleted</div>';
      } catch (e) { alert('Delete failed: ' + e.message); }
    }

    async function spamEmailAction(tabId, uid) {
      try {
        await electronAPI.spamEmail(tabId, uid, currentFolder[tabId]);
        currentEmails[tabId] = (currentEmails[tabId] || []).filter(e => e.uid != uid);
        renderEmailList(tabId);
        document.getElementById(`email-viewer-${tabId}`).innerHTML = '<div class="email-placeholder">Marked as spam</div>';
      } catch (e) { alert('Failed: ' + e.message); }
    }

    function formatDate(date) {
      if (!date) return '';
      try {
        const d = new Date(date);
        if (isNaN(d.getTime())) return '';
        
        const now = new Date();
        const diff = now - d;
        
        if (diff < 86400000) { // Less than 24 hours
          return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (diff < 604800000) { // Less than 7 days
          return d.toLocaleDateString([], { weekday: 'short' });
        } else {
          return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }
      } catch (e) {
        return '';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    init();
  </script>
</body>
</html>
